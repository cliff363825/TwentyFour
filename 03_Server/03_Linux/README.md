# 服务器篇之Linux
## 用户管理

1. 添加用户
   1. 指令
      ```
      useradd [选项] 用户名
      ```
   2. 细节说明
      1. 当创建用户成功后，会自动的创建和用户同名的家目录
      2. 也可以通过 `useradd -d 指定目录 新的用户名`，给新创建的用户指定家目录
         ```
         useradd -d /home/dog xq
         ```
   
2. 给用户指定或者修改密码
   1. 指令
      ```
      passwd 用户名
      ```
   
3. 删除用户
   1. 指令
      ```
      userdel 用户名
      ```
   2. 应用案例
      1. 删除用户xm，但是要保留家目录
         ```
         userdel xm
         ```
      2. 删除用户xq以及用户主目录
         ```
         userdel -r xq
         ```
   
4. 查询用户信息

   1. 指令

      ```
      id 用户名
      ```

   2. 细节说明

      1. 当用户不存在时，返回“无此用户”

5. 切换用户

   1. 指令

      ```
      su - 切换用户名
      ```

   2. 细节说明

      1. 从权限高的用户切换到权限低的用户，不需要输入密码，反之需要。
      2. 当需要返回到原来用户时，使用exit指令

6. 用户组

   1. 增加组

      ```
      groupadd 组名
      ```

   2. 删除组

      ```
      groupdel 组名
      ```

7. 增加用户时直接加上组

   1. 指令

      ```
      useradd -g 用户组 用户名
      ```

8. 修改用户的组

   1. 指令

      ```
      usermod -g 用户组 用户名
      ```

9. /etc/passwd 文件

   1. 用户（user）的配置文件，记录用户的各种信息

   2. 每行的含义：用户名:口令:用户标识号:组标识号:注释性描述:主目录:登录shell

      ```
      dst:x:1005:1005::/home/dst:/bin/bash
      ```

      | 用户名 | 口令 | 用户标识符 | 组标识符 | 注释性描述 | 主目录    | 登录shell |
      | ------ | ---- | ---------- | -------- | ---------- | --------- | --------- |
      | dst    | x    | 1005       | 1005     |            | /home/dst | /bin/bash |

10. /etc/shadow 文件

    1. 口令的配置文件
    2. 每行的含义：登录名:加密口令:最后一次修改时间:最小时间间隔:最大时间间隔:警告时间:不活动时间:标识

11. /etc/group 文件

    1. 组（group）的配置文件，记录Linux包含的组的信息

    2. 每行含义：组名:口令:组标识符:组内用户列表

       ```
       gitlab-www:x:990:www
       ```

       | 组名       | 口令 | 组标识符 | 组内用户列表 |
       | ---------- | ---- | -------- | ------------ |
       | gitlab-www | x    | 990      | www          |

## 实用指令

1. 指定运行级别

   1. 运行级别说明：

      ```
      0 关机
      1 单用户【找回丢失密码】
      2 多用户状态没有网络服务
      3 多用户状态有网络服务
      4 系统未使用保留给用户
      5 图形界面
      6 系统重启
      常用运行级别时 3 和 5，要修改默认的运行级别可改文件 /etc/inittab 的
      id:5:initdefault:
      这一行中的数字
      ```

2. 切换到指定运行级别的指令

   ```
   init [0123456]
   ```

3. 文件目录类

   1. pwd指令

      ```
      pwd 显示当前工作目录的绝对路径
      ```

   2. ls指令

      ```
      ls [选项] [目录或是文件]
      -a: 显示当前目录所有的文件和目录，包括隐藏的。
      -l: 以列表的方式显示信息
      
      #ls -al
      ```

   3. cd指令

      ```
      cd [参数] 切换到指定目录
      
      #cd ~  回到自己的家目录
      #cd    回到自己的家目录
      #cd .. 回到当前目录的上一级目录
      ```

   4. mkdir指令：用户创建目录

      ```
      mkdir [选项] 要创建的目录
      -p: 创建多级目录
      
      #mkdir -p ~/aaa/bbb/ccc
      ```

   5. rmdir指令：删除空目录

      ```
      rmdir [选项] 要删除的空目录
      
      #rmdir ~/aaa/bbb/ccc
      ```

   6. touch指令：创建空文件

      ```
      touch 文件名称
      
      #touch abc.txt
      ```

   7. cp指令：拷贝文件到指定目录

      ```
      cp [选项] source destination
      -r: 递归复制整个文件夹
      
      #cp abc.txt abc.txt.bak
      ```

   8. rm指令：删除文件或目录

      ```
      rm [选项] 要删除的文件或目录
      -r: 递归删除整个文件夹
      -f: 强制删除不提示
      
      #rm abc.txt
      ```

   9. mv指令

      ```
      mv oldNameFile newNameFile 重命名
      mv /temp/moveFile /targetFolder 移动文件
      
      #mv abc.txt.bak abc.txt
      ```

   10. cat指令：查看文件内容，是以只读的方式打开

       ```
       cat [选项] 要查看的文件
       -n: 显示行号
       
       #cat -n abc.txt
       ```

   11. more指令：是一个基于VI编辑器的文本过滤器，它以全屏幕的方式按页显示文本文件的内容。

       ```
       more 要查看的文件
       ```

       | 操作            | 功能说明                             |
       | --------------- | ------------------------------------ |
       | 空白键（space） | 代表向下翻一页                       |
       | Enter           | 代表向下翻一行                       |
       | q               | 代表立刻离开more，不再显示该文件内容 |
       | Ctrl+F          | 向下滚动一屏                         |
       | Ctrl+B          | 返回上一屏                           |
       | =               | 输出当前行的行号                     |
       | :f              | 输出文件名和当前行的行号             |

   12. less指令：用来分屏查看文件内容，他的功能与more指令类似，但是比more指令更加强大，支持各种终端。less指令在显示文件内容是，并不是一次将整个文件加载之后才显示，而是根据显示需要加在内容，对于显示大型文件具有较高的效率。

       ```
       less 要查看的文件
       ```

       | 操作       | 功能说明                                                 |
       | ---------- | -------------------------------------------------------- |
       | 空白键     | 向下翻动一页                                             |
       | [pagedown] | 向下翻动一页                                             |
       | [pageup]   | 向上翻动一页                                             |
       | /字串      | 向下搜寻【字串】的功能<br />n: 向下查找<br />N: 向上查找 |
       | ?字串      | 向上搜寻【字串】的功能<br />n: 向上查找<br />N: 向下查找 |
       | q          | 离开less这个程序                                         |

   13. `>`指令和`>>`指令

       ```
       > 输出重定向：会将原来的文件的内容覆盖
       >> 追加：不会覆盖原来文件的内容，而是追加到文件的尾部
       
       #echo "helloworld" >> abc.txt
       ```

   14. echo指令：输出内容到控制台

       ```
       echo [选项] 输出内容
       ```

   15. head指令：用于显示文件的开头部分内容，默认情况下head指令显示文件的前19行内容

       ```
       head 文件 查看文件头10行内容
       head -n 5 文件 查看文件头5行内容
       
       #head -n 5 abc.txt
       ```

   16. tail指令：用户输出文件中尾部的内容，默认情况下tail指令显示文件的后10行内容。

       ```
       tail 文件 查看文件后10行内容
       tail -n 5 文件 查看文件后5行内容
       tail -f 文件 实时追踪该文档的所有更新
       
       #tail -fn 5 abc.txt
       ```

   17. ln指令：软链接也叫符号链接，类似于windows里的快捷方式，主要存放了链接其他文件的路径

       ```
       ln -s [源文件或目录] [软链接名] 给源文件创建一个软链接
       
       #ln -s abc.txt abc
       ```

   18. history指令

       ```
       history 查看已经执行过历史命令
       ```

4. 时间日期类

   1. date指令-显示当前日期

      ```
      date 显示当前时间
      date +%Y 显示当前年份
      date +%m 显示当前月份
      date +%d 显示当前日期
      date "+%Y-%m-%d %H:%M:%S" 显示年月日时分秒
      ```

   2. date指令-设置日期

      ```
      date -s 字符串时间
      date -s "2019-11-11 22:22:22"
      ```

   3. cal指令：查看日历指令

      ```
      cal [选项] 不加选项，显示本月日历
      ```

5. 搜索查找类

   1. find指令

      ```
      find [搜索范围] [选项]
      -name 文件名 按照指定的文件名查找模式查找文件
      -user 用户名 查找属于指定用户名所有文件
      -size 文件大小N 按照执行的文件大小查找文件 +N大于 -N小于 N等于
      
      #find / -name abc.txt -size -10k
      ```

   2. locate指令

      ```
      locate 搜索文件
      由于locate指令基于数据库进行查询，所以第一次运行前，必须使用updatedb指令创建locate数据库。
      ```

   3. grep指令和管道符号 |

      ```
      grep [选项] 查找内容 源文件
      -n: 显示匹配行及行号
      -i: 忽略字母大小写
      
      #cat abc.txt|grep -n hello
      ```

6. 压缩和解压类

   1. gzip/gunzip指令

      ```
      gzip 文件 压缩文件，只能将文件压缩为*.gz文件
      gunzip 文件.gz 解压缩文件命令
      当我们使用gzip对文件进行压缩后，不会保留原来的文件
      
      #gzip abc.txt
      #gunzip abc.txt.gz
      ```

   2. zip/unzip指令

      ```
      zip [选项] xxx.zip 将要压缩的内容  压缩文件和目录的命令
      -r: 递归压缩，即压缩目录
      #zip -r aaa.zip ~/aaa
      
      unzip [选项] xxx.zip  解压缩文件
      -d 目录: 指定解压后文件的存放目录
      #unzip -d ~/bbb aaa.zip
      ```

   3. tar指令

      ```
      tar [选项] xxx.tar.gz 打包的内容  打包目录，压缩后的文件格式.tar.gz
      -c: 产生.tar打包文件
      -v: 显示详细信息
      -f: 指定压缩后的文件名
      -z: 打包同时压缩
      -x: 解包.tar文件
      
      #tar -zcvf aaa.tar.gz abc.txt cba.txt
      #tar -zxvf aaa.tar.gz
      ```

## 组管理和权限管理

1. 查看文件的所有者

   ```
   ls -ahl
   ```

2. 修改文件所有者

   ```
   chown 用户名 文件名
   ```

3. 组的创建

   ```
   groupadd 组名
   ```

4. 修改文件所在组

   ```
   chgrp 组名 文件名
   ```

5. 改变用户所在组

   ```
   usermod -g 组名 用户名
   usermod -d 目录名 用户名 改变该用户登录的初始目录
   ```

6. 权限的基本介绍

   1. -rwxrw-r--
   2. 第0位确定文件类型（d, -, l, c, b）
   3. 第1-3位确定所有者（该文件的所有者）拥有该文件的权限。——User
   4. 第4-6位确定所属组（同用户组的）拥有该文件的权限。——Group
   5. 第7-9位确定其他用户拥有该文件的权限。——Other

7. rwx权限详解

   1. rwx作用到文件
      1. [r]代表可读(read)：可以读取、查看
      2. [w]代表可写(write)：可以修改，但是不代表可以删除该文件，删除一个文件的前提条件是对该文件所在的目录有写权限，才能删除该文件。
      3. [x]代表可执行(execute)：可以被执行
   2. rwx作用到目录
      1. [r]代表可读(read)：可以读取，ls查看目录内容
      2. [w]代表可写(write)：可以修改，目录内创建+删除+重命名目录。
      3. [x]代表可执行(execute)：可以进入该目录

8. 修改权限-chmod

   1. 第一种方式：+、-、=变更权限

      ```
      u:所有者 g:所有组 o:其他人 a:所有人(u,g,o的总和)
      chmod u=rwx,g=rx,o=x 文件目录名
      chmod o+x 文件目录名
      chmod a-x 文件目录名
      ```

   2. 第二种方式：通过数字变更权限

      ```
      r=4 w=2 x=1，rwx=4+2+1=7
      chmod 755 文件目录名
      ```

9. 修改文件所有者 - chown

   ```
   chown user file 改变文件的所有者
   chown user:group file 改变文件的所有者和所有组
   -R: 如果是目录，则使其下所有子文件或目录递归生效
   ```

10. 修改文件所在组 - chgrp

    ```
    chgrp group file 改变文件的所有组
    ```

## crond任务调度

## 生产环境服务器变慢，诊断思路和性能评估

1. 整机：top
2. CPU：vmstat
   1. 查看CPU（包含不限于）
      1. `vmstat -n 2 3`
      2. 一般vmstat工具的使用是通过两个数字参数来完成的，第一个参数是采样的时间间隔数单位是秒，第二个参数是采样的次数
      3. procs：
         1. r：运行和等待CPU时间片的进程数，原则上1核的CPU的运行队列不要超过2，整个系统的运行队列不能超过总核数的2倍，否则代表系统压力过大。
         2. b：等待资源的进程数，比如正在等待磁盘IO、网络IO等
      4. cpu：
         1. us：用户进程消耗CPU时间百分比，us值高，用户进程消耗CPU时间多，如果长期大于50%，优化程序
         2. sy：内核进程消耗的CPU时间百分比
         3. us + sy 参考值为80%，如果 us+sy 大于80%，说明可能存在CPU不足
         4. id：处于空闲的CPU百分比
         5. wa：系统等待IO的CPU时间百分比
         6. st：来自于一个虚拟机偷取的CPU时间的百分比
   2. 查看额外
      1. 查看所有CPU核信息
         1. mpstat -P ALL 2
      2. 每个进程使用CPU的用量分解信息
         1. `pidstat [ 选项 ] [ <时间间隔> ] [ <次数> ]`
         2. pidstat -u -p 进程编号 1
   3. 内存：free
      1. 应用程序可用内存数
         1. 应用程序可用内存/系统物理内存 > 70% 内存充足
         2. 应用程序可用内存/系统物理内存 < 70% 内存不足，需要增加内存
         3. 20%<应用程序可用内存/系统物理内存<70% 内存基本够用
      2. 查看额外
         1. pidstat -r -p 进程号 时间间隔
   4. 硬盘：df
      1. 查看磁盘剩余空闲数
   5. 磁盘IO：iostat
      1. 磁盘IO性能评估
         1. iostat -xdk 2 3
         2. 磁盘块设备分布
            1. rkB/s 每秒读取数据量kB
            2. wkB/s 每秒写入数据量kB
            3. svctm IO请求的平均服务时间，单位毫秒
            4. await IO请求的平均等待时间，单位毫秒，值越小，性能越好
            5. util 一秒中有百分几的时间用于IO操作，接近100%时，表示磁盘带宽跑满，需要优化程序或者增加磁盘
            6. rkB/s、wkB/s根据系统应用不同会有不同的值，但有规律遵循，长期、超大数据读写，肯定不正常，需要优化程序读取。
            7. svctm的值与await的值很接近，表示几乎没有IO等待，磁盘性能好
            8. 如果await的值远高于svctm的值，则表示IO队列等待太长，需要优化程序或更换更快磁盘
      2. 查看额外
         1. pidstat -d -p 进程编号
   6. 网络IO：ifstat
      1. 默认本地没有，下载ifstat
      2. 查看网络IO
         1. ifstat 1

## CPU占用过高的定位分析思路

1. 结合Linux和JDK命令一块分析

2. 案例步骤

   1. 先用top命令找出CPU占比最高的

   2. ps -ef或者jps进一步定位，得知是一个怎么样的一个后台程序给我们惹事

      ```
      ps -ef|grep java|grep -v grep
      ```

   3. 定位到具体线程或者代码

      ```
      ps -mp 进程 -o THREAD,tid,time
      ```

      1. 参数解释
         1. -m 显示所有的线程
         2. -p pid进程使用CPU的时间
         3. -o 该参数后是用户自定义格式

   4. 将需要的线程ID转换为16进制格式（英文小写格式）

      ```
      printf "%x\n" 有问题的线程ID
      ```

   5. jstack 进程ID|grep tid（16进制线程ID小写英文）

      ```
      jstack 5101|grep 13ee -A60
      ```

      

 

 

 

